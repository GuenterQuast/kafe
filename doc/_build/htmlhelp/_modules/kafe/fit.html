

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso8859_1" />
    
    <title>kafe.fit</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="top" title="kafe 3.1alpha1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">kafe 3.1alpha1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <h1>Source code for kafe.fit</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>

<span class="sd">This submodule defines a `Fit` object which performs the actual fitting given a `Dataset` and a fit function.</span>

<span class="sd">.. moduleauthor:: Daniel Savoiu &lt;daniel.savoiu@ekp.kit.edu&gt;</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">minuit</span> <span class="kn">import</span> <span class="n">Minuit</span>
<span class="kn">from</span> <span class="nn">function_tools</span> <span class="kn">import</span> <span class="n">get_function_property</span><span class="p">,</span> <span class="n">outer_product</span><span class="p">,</span> <span class="n">derive_by_x</span>

<span class="kn">from</span> <span class="nn">numeric_tools</span> <span class="kn">import</span> <span class="o">*</span>                 <span class="c"># automatically includes numpy as np</span>
<span class="kn">from</span> <span class="nn">constants</span> <span class="kn">import</span> <span class="n">F_SIGNIFICANCE</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">floor</span><span class="p">,</span> <span class="n">log</span>

<span class="c"># The default FCN</span>
<div class="viewcode-block" id="chi2"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.chi2">[docs]</a><span class="k">def</span> <span class="nf">chi2</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">fit_function</span><span class="p">,</span> <span class="n">param_values</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A simple S{chi}-square implementation. Calculates S{chi}-square according to the formula:</span>
<span class="sd">    </span>
<span class="sd">    M{ S{chi}^2 = S{lambda}^T . C^(-1) . S{lambda} }</span>
<span class="sd">    </span>
<span class="sd">    Here, S{lambda} is the residual vector: M{ S{lambda} = y - f(x) }</span>
<span class="sd">    </span>
<span class="sd">    @param xdata: The I{x} measurement data</span>
<span class="sd">    @param ydata: The I{y} measurement data</span>
<span class="sd">    @param cov_mat: The total covariance matrix</span>
<span class="sd">    @param fit_function: The fit function M{f(x)}</span>
<span class="sd">    @param param_values: The values of the parameters at which M{f(x)} should be evaluated.</span>
<span class="sd">    </span>
<span class="sd">    @type xdata: numpy.array</span>
<span class="sd">    @type ydata: numpy.array</span>
<span class="sd">    @type cov_mat: numpy.matrix</span>
<span class="sd">    @type fit_function: function</span>
<span class="sd">    @type param_values: tuple</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c"># since the param_values are constants, the</span>
    <span class="c"># fit function is a function of only one</span>
    <span class="c"># variable: `x&#39;. To apply it elementwise using</span>
    <span class="c"># Python&#39;s `map&#39; method, make a temporary</span>
    <span class="c"># function where `x&#39; is the only variable:</span>
    <span class="k">def</span> <span class="nf">tmp_fit_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fit_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">param_values</span><span class="p">)</span>

    <span class="n">fdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">tmp_fit_function</span><span class="p">,</span> <span class="n">xdata</span><span class="p">))</span>        <span class="c"># calculate f(x) for all x in xdata</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="n">ydata</span> <span class="o">-</span> <span class="n">fdata</span>                                <span class="c"># calculate residual vector</span>

    <span class="k">return</span> <span class="n">residual</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">.</span><span class="n">I</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>          <span class="c"># return the chi^2</span>
</div>
<div class="viewcode-block" id="Fit"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit">[docs]</a><span class="k">class</span> <span class="nc">Fit</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Object representing a fit. Has references to the fitted dataset, the fit function and the resulting fit parameters.&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">fit_function</span><span class="p">,</span> <span class="n">external_fcn</span><span class="o">=</span><span class="n">chi2</span><span class="p">,</span> <span class="n">function_label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Constuct a fit. Necessary arguments are a dataset and a fit function (which is fitted to the dataset).</span>
<span class="sd">        Optionally, an external B{FCN} (whose minima should be located to find the best fit) can be specified.</span>
<span class="sd">        If not given, the B{FCN} defaults to S{chi}-square.</span>
<span class="sd">        </span>
<span class="sd">        @param dataset: A `Dataset` object containing all information about the data</span>
<span class="sd">        @type dataset: `Dataset`</span>
<span class="sd">        </span>
<span class="sd">        @param fit_function: A Python function to be fitted to the data</span>
<span class="sd">        @type fit_function: function (first argument is considered to be independent variable I{x})</span>
<span class="sd">        </span>
<span class="sd">        @param external_fcn: An external B{FCN} (function to minimize)</span>
<span class="sd">        @type external_fcn: function with call signature `FCN(xdata, ydata, cov_mat, fit_function, param_values)`</span>
<span class="sd">        </span>
<span class="sd">        @param function_label: Function name/label/short description.</span>
<span class="sd">        @type function_label: string</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c"># Initialize instance variables</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span> <span class="o">=</span> <span class="n">fit_function</span>    <span class="c"># refer to the fit function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_fcn</span> <span class="o">=</span> <span class="n">external_fcn</span>    <span class="c"># refer to the (external) function to me minimized</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span> <span class="o">=</span> <span class="n">get_function_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span><span class="p">,</span> <span class="s">&#39;number of parameters&#39;</span><span class="p">)</span>    <span class="c"># set param number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_param_values</span> <span class="o">=</span> <span class="n">get_function_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span><span class="p">,</span> <span class="s">&#39;parameter defaults&#39;</span><span class="p">)</span>      <span class="c"># set current params to default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">get_function_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span><span class="p">,</span> <span class="s">&#39;parameter names&#39;</span><span class="p">)</span>                  <span class="c"># set parameter names</span>
        
        <span class="k">if</span> <span class="n">function_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_label</span> <span class="o">=</span> <span class="n">function_label</span>     <span class="c"># get the function name from the arguments</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_label</span> <span class="o">=</span> <span class="s">r&#39;\verb!</span><span class="si">%s</span><span class="s">!&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">get_function_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">),</span> <span class="p">)</span>   <span class="c"># get the function name and wrap it in LaTeX</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">has_any_errors</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">):</span>                       <span class="c"># check if the dataset has any y errors at all</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_cov_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_cov_mat</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>    <span class="c"># set the y cov_mat as starting cov_mat for the fit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asmatrix</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_size</span><span class="p">())</span> <span class="p">)</span>  <span class="c"># set the identity matrix as starting cov_mat for the fit</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span> <span class="o">=</span> <span class="n">Minuit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_external_fcn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_param_values</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>                      <span class="c"># initialize minimizer for fit</span>
        <span class="c">#self.minimizer = Minuit(self.call_external_fcn)                      # initialize minimizer for fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">set_parameter_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_param_values</span><span class="p">)</span>        <span class="c"># set Minuit&#39;s start parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">set_parameter_errors</span><span class="p">()</span>                                 <span class="c"># set Minuit&#39;s parameter errors</span>
        
        <span class="c"># Some shortcuts for better readability</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span>
        
    
<div class="viewcode-block" id="Fit.call_external_fcn"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.call_external_fcn">[docs]</a>    <span class="k">def</span> <span class="nf">call_external_fcn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">param_values</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wrapper for the external B{FCN}. Since the actual fit process depends on finding the right parameter</span>
<span class="sd">        values and keeping everything else constant, we can use the `Dataset` object to pass known, fixed</span>
<span class="sd">        information to the external B{FCN}, varying only the parameter values.</span>
<span class="sd">        </span>
<span class="sd">        @param param_values: the parameter values at which B{FCN} is to be evaluated (tuple)</span>
<span class="sd">        @type param_values: sequence of floats</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_fcn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_cov_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span><span class="p">,</span> <span class="n">param_values</span><span class="p">)</span> 
        </div>
<div class="viewcode-block" id="Fit.get_current_fit_function"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.get_current_fit_function">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_fit_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method returns a function object corresponding to the fit function</span>
<span class="sd">        for the current parameter values. The returned function is a function of</span>
<span class="sd">        a single variable.</span>
<span class="sd">        </span>
<span class="sd">        @param x_0: Value of I{x} at which to evaluate the fit function</span>
<span class="sd">        @type x_0: float</span>
<span class="sd">        </span>
<span class="sd">        @return: function</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">current_fit_function</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">current_param_values</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">current_fit_function</span>
    </div>
<div class="viewcode-block" id="Fit.get_error_matrix"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.get_error_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">get_error_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method returns the covariance matrix of the fit parameters which is obtained</span>
<span class="sd">        by querying the minimizer object for this fit</span>
<span class="sd">        </span>
<span class="sd">        @return: np.matrix</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_error_matrix</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="Fit.do_fit"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.do_fit">[docs]</a>    <span class="k">def</span> <span class="nf">do_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;does a preliminary fit and then iterates for x error&#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;###########&quot;</span>
            <span class="k">print</span> <span class="s">&quot;# Dataset #&quot;</span>
            <span class="k">print</span> <span class="s">&quot;###########&quot;</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_formatted</span><span class="p">()</span>
            
            <span class="k">print</span> <span class="s">&quot;################&quot;</span>
            <span class="k">print</span> <span class="s">&quot;# Fit function #&quot;</span>
            <span class="k">print</span> <span class="s">&quot;################&quot;</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="k">print</span> <span class="n">get_function_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            
        <span class="n">iter_nr</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">while</span> <span class="n">iter_nr</span> <span class="o">&lt;</span> <span class="n">maxiter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_one_iteration</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
            
            <span class="c"># if the dataset has x errors, project them onto the current error matrix</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">has_any_errors</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project_x_covariance_matrix</span><span class="p">()</span>
                
            <span class="n">iter_nr</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">print_fit_results</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_rounded_fit_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_fit_details</span><span class="p">()</span>
        </div>
<div class="viewcode-block" id="Fit.fit_one_iteration"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.fit_one_iteration">[docs]</a>    <span class="k">def</span> <span class="nf">fit_one_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;does one iteration of Minuit minimization&#39;&#39;&#39;</span>
        
        
        <span class="c"># self.minimizer.set_print_level(-1000)</span>
        <span class="c">##print self.current_cov_mat</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_param_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_parameter_values</span><span class="p">()</span>
        
        <span class="c">#self.print_rounded_fit_parameters()</span>
        
        <span class="n">par_cov_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_matrix</span><span class="p">()</span>
        <span class="c">#par_errs = np.diag(par_cov_mat)</span>
        <span class="c">#print par_cov_mat</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="k">print</span> <span class="s">&quot;Parameter correlation:&quot;</span>
            <span class="k">print</span> <span class="s">&quot;=====================&quot;</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="k">print</span> <span class="n">cov_to_cor</span><span class="p">(</span><span class="n">par_cov_mat</span><span class="p">)</span>
            
        
        <span class="c"># self.minimizer.set_print_level(0)</span>
      </div>
<div class="viewcode-block" id="Fit.project_x_covariance_matrix"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.project_x_covariance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">project_x_covariance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;projects the x errors from the x-covariance matrix onto the total matrix&#39;&#39;&#39;</span>
        
        <span class="n">derivative_spacing</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_error_matrix</span><span class="p">())))</span>    <span class="c"># use 1/100th of the smallest parameter error as spacing for df/dp</span>
        <span class="n">proj_xcov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_cov_mat</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="n">outer_product</span><span class="p">(</span> <span class="n">derive_by_x</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_function</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_param_values</span><span class="p">,</span> <span class="n">derivative_spacing</span><span class="p">)</span> <span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">current_cov_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_cov_mat</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">asmatrix</span><span class="p">(</span><span class="n">proj_xcov_mat</span><span class="p">)</span>
        <span class="c">##print self.current_cov_mat</span>
    </div>
<div class="viewcode-block" id="Fit.print_rounded_fit_parameters"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.print_rounded_fit_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">print_rounded_fit_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;prints the fit parameters&#39;&#39;&#39;</span>
        
        <span class="k">print</span> <span class="s">&quot;########################&quot;</span>
        <span class="k">print</span> <span class="s">&quot;# Final fit parameters #&quot;</span>
        <span class="k">print</span> <span class="s">&quot;########################&quot;</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_parameter_info</span><span class="p">():</span>
            
            <span class="c"># round error to F_SIGNIFICANCE significant digits</span>
            <span class="n">significant_digits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">floor</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="o">/</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span> <span class="o">+</span> <span class="n">F_SIGNIFICANCE</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">error</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">significant_digits</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">significant_digits</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%g</span><span class="s"> +- </span><span class="si">%g</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
    </div>
<div class="viewcode-block" id="Fit.print_fit_details"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.print_fit_details">[docs]</a>    <span class="k">def</span> <span class="nf">print_fit_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;prints some fit goodness details&#39;&#39;&#39;</span>
        
        <span class="n">chi2prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_chi2_probability</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chi2prob</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">hypothesis_status</span> <span class="o">=</span> <span class="s">&#39;rejected (CL 5%)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hypothesis_status</span> <span class="o">=</span> <span class="s">&#39;accepted (CL 5%)&#39;</span>
            
        <span class="k">print</span> <span class="s">&#39;###############&#39;</span>
        <span class="k">print</span> <span class="s">&quot;# Fit details #&quot;</span>
        <span class="k">print</span> <span class="s">&quot;###############&quot;</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        <span class="k">print</span> <span class="s">&#39;FCN     &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_fit_info</span><span class="p">(</span><span class="s">&#39;fcn&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;FCN/ndf &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_fit_info</span><span class="p">(</span><span class="s">&#39;fcn&#39;</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_size</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_parameters</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;EdM     &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_fit_info</span><span class="p">(</span><span class="s">&#39;edm&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;UP      &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_fit_info</span><span class="p">(</span><span class="s">&#39;err_def&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;STA     &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimizer</span><span class="o">.</span><span class="n">get_fit_info</span><span class="p">(</span><span class="s">&#39;status_code&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        <span class="k">print</span> <span class="s">&#39;chi2prob&#39;</span><span class="p">,</span> <span class="n">chi2prob</span>
        <span class="k">print</span> <span class="s">&#39;H0      &#39;</span><span class="p">,</span> <span class="n">hypothesis_status</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        
        </div>
<div class="viewcode-block" id="Fit.print_fit_results"><a class="viewcode-back" href="../../api/kafe.html#kafe.fit.Fit.print_fit_results">[docs]</a>    <span class="k">def</span> <span class="nf">print_fit_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;prints fit results&#39;&#39;&#39;</span>
        
        <span class="k">print</span> <span class="s">&#39;##############&#39;</span>
        <span class="k">print</span> <span class="s">&#39;# Fit result #&#39;</span>
        <span class="k">print</span> <span class="s">&#39;##############&#39;</span>
        <span class="k">print</span> <span class="s">&#39;&#39;</span>
        
        <span class="n">par_cov_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error_matrix</span><span class="p">()</span>
        <span class="n">par_err</span> <span class="o">=</span> <span class="n">extract_statistical_errors</span><span class="p">(</span><span class="n">par_cov_mat</span><span class="p">)</span>
        <span class="n">par_cor_mat</span> <span class="o">=</span> <span class="n">cov_to_cor</span><span class="p">(</span><span class="n">par_cov_mat</span><span class="p">)</span>
        
        
        <span class="k">for</span> <span class="n">par_nr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_param_values</span><span class="p">)):</span>
            <span class="k">print</span> <span class="s">&#39;# &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="n">par_nr</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&#39;# value        stat. err.    &#39;</span><span class="p">,</span>
            <span class="k">if</span> <span class="n">par_nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;correlations&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="k">print</span> <span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_param_values</span><span class="p">[</span><span class="n">par_nr</span><span class="p">],</span> <span class="s">&#39;.06e&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;  &#39;</span><span class="p">,</span>
            <span class="k">print</span> <span class="n">format</span><span class="p">(</span><span class="n">par_err</span><span class="p">[</span><span class="n">par_nr</span><span class="p">],</span> <span class="s">&#39;.06e&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;  &#39;</span><span class="p">,</span>
            <span class="k">if</span> <span class="n">par_nr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">par_nr</span><span class="p">):</span>
                    <span class="k">print</span> <span class="n">format</span><span class="p">(</span><span class="n">par_cor_mat</span><span class="p">[</span><span class="n">par_nr</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="s">&#39;.06e&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;  &#39;</span><span class="p">,</span>
                    
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            <span class="k">print</span> <span class="s">&#39;&#39;</span>
            
            
        
        </div></div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    
    <span class="kn">from</span> <span class="nn">dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
    
    <span class="k">def</span> <span class="nf">linear_2par2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">slope</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        
        <span class="k">return</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_offset</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">linear_2par</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">slope</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_intercept</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        
        <span class="k">return</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y_intercept</span>
    
    <span class="n">myXData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">3</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">6</span><span class="p">,</span> <span class="o">.</span><span class="mi">7</span><span class="p">,</span> <span class="o">.</span><span class="mi">8</span><span class="p">,</span> <span class="o">.</span><span class="mi">9</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
    <span class="n">myYData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.227216</span><span class="p">,</span>    <span class="o">-</span><span class="mf">0.159875</span><span class="p">,</span>    <span class="mf">0.0924984</span><span class="p">,</span>    <span class="o">-</span><span class="mf">0.299377</span><span class="p">,</span>    <span class="mf">0.307159</span><span class="p">,</span>    <span class="mf">1.15718</span><span class="p">,</span>    <span class="mf">0.701532</span><span class="p">,</span>    <span class="mf">0.661879</span><span class="p">,</span>    <span class="mf">0.536548</span><span class="p">,</span>    <span class="mf">0.874998</span><span class="p">,</span>    <span class="mf">1.02603</span><span class="p">])</span>
    <span class="n">tstFloat</span> <span class="o">=</span> <span class="mf">0.3</span>
     
    <span class="n">myDataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">xdata</span><span class="o">=</span><span class="n">myXData</span><span class="p">,</span> 
                        <span class="n">ydata</span><span class="o">=</span><span class="n">myYData</span><span class="p">,</span>
                        <span class="n">yabsstat</span><span class="o">=</span><span class="n">tstFloat</span><span class="p">)</span>
    
    <span class="n">myFit</span> <span class="o">=</span> <span class="n">myDataset</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">linear_2par2</span><span class="p">)</span>
    <span class="n">myFit</span><span class="o">.</span><span class="n">do_fit</span><span class="p">()</span>
    
<span class="c">#     myDataset = Dataset(xdata=myXData, </span>
<span class="c">#                         ydata=myYData,</span>
<span class="c">#                         xabsstat=tstFloat)</span>
<span class="c">#     </span>
<span class="c">#     myFit = myDataset.fit(linear_2par2)</span>
<span class="c">#     myFit.do_fit()</span>
    
<span class="c">#     myDataset2 = Dataset(xdata=myXData, </span>
<span class="c">#                         ydata=myYData,</span>
<span class="c">#                         yabsstat=tstFloat,</span>
<span class="c">#                         xabssyst=0.2)</span>
<span class="c">#     </span>
    
    <span class="c">#myFit2 = myDataset2.fit(linear_2par2)</span>
    
    <span class="c">#print myDataset2.get_cov_mat(&#39;y&#39;)</span>
    <span class="c">#print myDataset2.get_cov_mat(&#39;x&#39;)</span>
    
    
    <span class="c">#myFit2.do_fit(quiet=True)</span>
    
    <span class="c">#print myFit2.current_cov_mat</span>
</pre></div>

          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">kafe 3.1alpha1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Daniel Savoiu.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>